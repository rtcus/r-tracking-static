name: CDNå¥åº·ç›‘æ§
on:
  schedule:
    - cron: '*/30 * * * *'  # æ”¹ä¸ºæ¯30åˆ†é’Ÿä¸€æ¬¡ï¼ˆæ›´ç¨³å®šï¼‰
  workflow_dispatch:        # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” æ£€æŸ¥CDNå¯ç”¨æ€§
        id: check
        run: |
          echo "å¼€å§‹CDNå¥åº·æ£€æŸ¥ $(date)"
          
          # å®šä¹‰è¦æ£€æŸ¥çš„URL
          urls=(
            "Bootstrap CSS|https://cdn.rtcus.cn/libs/bootstrap/css/bootstrap.min.css"
            "Font Awesome|https://cdn.rtcus.cn/libs/font-awesome/css/all.min.css"
            "Bootstrap JS|https://cdn.rtcus.cn/libs/bootstrap/js/bootstrap.bundle.min.js"
            "LeanCloud|https://cdn.rtcus.cn/libs/leancloud-storage/av-min.js"
          )
          
          failed_urls=()
          all_output=""
          has_failed="false"
          
          for url_pair in "${urls[@]}"; do
            name="${url_pair%|*}"
            url="${url_pair#*|}"
            
            echo -n "æ£€æŸ¥ $name ($url)... "
            start_time=$(date +%s%3N)
            
            if curl -s -f --max-time 10 "$url" > /dev/null; then
              end_time=$(date +%s%3N)
              response_time=$((end_time - start_time))
              echo "âœ… ${response_time}ms"
              all_output+="âœ… $name: ${response_time}ms\n"
            else
              echo "âŒ å¤±è´¥"
              all_output+="âŒ $name: å¤±è´¥\n"
              failed_urls+=("$name: $url")
              has_failed="true"
            fi
          done
          
          # è¾“å‡ºç»“æœ
          echo "æ£€æŸ¥å®Œæˆï¼š"
          echo -e "$all_output"
          
          # ä½¿ç”¨æ–°è¯­æ³•è®¾ç½®è¾“å‡º
          echo "has_failed=$has_failed" >> $GITHUB_OUTPUT
          echo "failed_list=${failed_urls[*]}" >> $GITHUB_OUTPUT
          if [ "$has_failed" = "true" ]; then
            echo "summary=âŒ CDNå¼‚å¸¸ - ${#failed_urls[@]}ä¸ªæœåŠ¡å¤±è´¥" >> $GITHUB_OUTPUT
          else
            echo "summary=âœ… CDNæ‰€æœ‰æœåŠ¡æ­£å¸¸" >> $GITHUB_OUTPUT
          fi
          echo "full_report<<EOF" >> $GITHUB_OUTPUT
          echo -e "$all_output" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: ğŸ“ è®°å½•æ£€æŸ¥ç»“æœ
        run: |
          echo "æ£€æŸ¥ç»“æœï¼š${{ steps.check.outputs.summary }}"
          echo "è¯¦ç»†æŠ¥å‘Šï¼š"
          echo "${{ steps.check.outputs.full_report }}"
          
      # é‚®ä»¶é€šçŸ¥éƒ¨åˆ†æš‚æ—¶æ³¨é‡Šæ‰ï¼Œéœ€è¦é…ç½®Secrets
      # - name: ğŸ“§ å‘é€é‚®ä»¶é€šçŸ¥ï¼ˆå¦‚æœå¤±è´¥ï¼‰
      #   if: steps.check.outputs.has_failed == 'true'
      #   uses: dawidd6/action-send-mail@v3
      #   with:
      #     server_address: smtp.gmail.com
      #     server_port: 465
      #     username: ${{ secrets.EMAIL_USER }}
      #     password: ${{ secrets.EMAIL_PASS }}
      #     subject: 'ğŸš¨ Rè·Ÿå•å°CDNç›‘æ§å‘Šè­¦'
      #     to: ${{ secrets.ALERT_EMAIL }}
      #     from: GitHub Actions
      #     body: |
      #       CDNç›‘æ§å‘ç°å¼‚å¸¸ï¼
      #       å¤±è´¥çš„æœåŠ¡ï¼š${{ steps.check.outputs.failed_list }}
      #       è¯¦ç»†æŠ¥å‘Šï¼š${{ steps.check.outputs.full_report }}
      #       æ—¶é—´ï¼š$(date)
      #       è¯·ç«‹å³æ£€æŸ¥ï¼šhttps://cdn.rtcus.cn
