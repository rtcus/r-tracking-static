name: ğŸ“Š CDNå¥åº·ç›‘æ§
on:
  schedule:
    - cron: '*/15 * * * *'  # æ¯15åˆ†é’Ÿä¸€æ¬¡
  workflow_dispatch:        # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” æ£€æŸ¥CDNå¯ç”¨æ€§
        id: check
        run: |
          echo "å¼€å§‹CDNå¥åº·æ£€æŸ¥ $(date)"
          
          # å®šä¹‰è¦æ£€æŸ¥çš„URL
          urls=(
            "Bootstrap CSS|https://cdn.rtcus.cn/libs/bootstrap/css/bootstrap.min.css"
            "Font Awesome|https://cdn.rtcus.cn/libs/font-awesome/css/all.min.css"
            "Bootstrap JS|https://cdn.rtcus.cn/libs/bootstrap/js/bootstrap.bundle.min.js"
            "LeanCloud|https://cdn.rtcus.cn/libs/leancloud-storage/av-min.js"
          )
          
          failed_urls=()
          all_output=""
          
          for url_pair in "${urls[@]}"; do
            name="${url_pair%|*}"
            url="${url_pair#*|}"
            
            echo -n "æ£€æŸ¥ $name ($url)... "
            start_time=$(date +%s%3N)
            
            if curl -s -f --max-time 10 "$url" > /dev/null; then
              end_time=$(date +%s%3N)
              response_time=$((end_time - start_time))
              echo "âœ… ${response_time}ms"
              all_output+="âœ… $name: ${response_time}ms\\n"
            else
              echo "âŒ å¤±è´¥"
              all_output+="âŒ $name: å¤±è´¥\\n"
              failed_urls+=("$name: $url")
            fi
          done
          
          # è¾“å‡ºç»“æœ
          echo "æ£€æŸ¥å®Œæˆï¼š"
          echo -e "$all_output"
          
          # å¦‚æœæœ‰å¤±è´¥çš„ï¼Œè®¾ç½®è¾“å‡ºå˜é‡
          if [ ${#failed_urls[@]} -gt 0 ]; then
            echo "::set-output name=has_failed::true"
            echo "::set-output name=failed_list::${failed_urls[*]}"
            echo "::set-output name=summary::âŒ CDNå¼‚å¸¸ - ${#failed_urls[@]}ä¸ªæœåŠ¡å¤±è´¥"
          else
            echo "::set-output name=has_failed::false"
            echo "::set-output name=summary::âœ… CDNæ‰€æœ‰æœåŠ¡æ­£å¸¸"
          fi
          
          # è¾“å‡ºæ‰€æœ‰ç»“æœä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "::set-output name=full_report::$(echo -e "$all_output")"
          
      - name: ğŸ“§ å‘é€é‚®ä»¶é€šçŸ¥ï¼ˆå¦‚æœå¤±è´¥ï¼‰
        if: steps.check.outputs.has_failed == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: 'ğŸš¨ Rè·Ÿå•å°CDNç›‘æ§å‘Šè­¦'
          to: ${{ secrets.ALERT_EMAIL }}
          from: GitHub Actions
          body: |
            CDNç›‘æ§å‘ç°å¼‚å¸¸ï¼
            
            å¤±è´¥çš„æœåŠ¡ï¼š
            ${{ steps.check.outputs.failed_list }}
            
            è¯¦ç»†æŠ¥å‘Šï¼š
            ${{ steps.check.outputs.full_report }}
            
            æ—¶é—´ï¼š$(date)
            
            è¯·ç«‹å³æ£€æŸ¥ï¼šhttps://cdn.rtcus.cn
            
            æ¥è‡ªï¼šGitHub Actions CDNç›‘æ§
            
      - name: ğŸ’¬ å‘é€Slacké€šçŸ¥ï¼ˆå¯é€‰ï¼‰
        if: steps.check.outputs.has_failed == 'true'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: 'ç›‘æ§é¢‘é“ID'
          slack-message: |
            ğŸš¨ CDNç›‘æ§å‘Šè­¦
            ${{ steps.check.outputs.summary }}
            å¤±è´¥ï¼š${{ steps.check.outputs.failed_list }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          
      - name: ğŸ“ è®°å½•æ£€æŸ¥ç»“æœ
        run: |
          echo "æ£€æŸ¥ç»“æœï¼š${{ steps.check.outputs.summary }}"
          echo "è¯¦ç»†æŠ¥å‘Šï¼š"
          echo "${{ steps.check.outputs.full_report }}"
